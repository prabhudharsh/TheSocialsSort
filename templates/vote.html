<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ category['name'] }} - Voting</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Ubuntu+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vote.css') }}">
</head>
<body>
    <header class="navbar">
        <div class="logo-container">
            <a href="{{ url_for('dashboard') }}" class="logo-link">
                <span class="logo-text">The Social Sort</span>
            </a>
        </div>
        <div class="profile-icon">
             <a href="{{ url_for('user_profile', username=session['username']) }}">
                <img src="{{ url_for('static', filename='images/' + ('male.png' if gender == 'male' else 'female.png')) }}" alt="Profile">
            </a>
        </div>
    </header>

    <main class="vote-container">
        <h1 class="vote-title">Cast your votes for the {{ category['name'] }}</h1>
        <p class="vote-subtitle" id="vote-subtitle"></p>

        <div class="candidates-container">
            {% for c in candidates %}
            <div class="candidate" data-id="{{ c['id'] }}">
                <div class="candidate-image-wrapper">
                   <img 
                     src="{{ url_for('static', filename='images/' + ('male.png' if c.gender == 'male' else 'female.png')) }}" 
                     alt="{{ c['full_name'] or c['username'] }}"
                     class="{% if (c.gender == 'female' and loop.index == 1) or (c.gender == 'male' and loop.index == 2) %}flip-h{% endif %}">
                </div>
                <p class="candidate-name">{{ c['full_name'] or c['username'] }}</p>
            </div>
            {% endfor %}
        </div>

        <div class="progress-section">
            <div class="progress-bar-container">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: {{ (votes_count / MAX_VOTES) * 100 }}%;"></div>
            </div>
            <p id="progress-label" class="progress-label">{{ votes_count }} / {{ MAX_VOTES }} Votes</p>
        </div>
        
        <div class="button-wrapper">
            <button class="btn-next" id="next-btn">Next</button>
            <div class="final-actions" id="final-actions">
               <button class="btn-rank" id="rank-btn" onclick="window.location.href='{{ url_for('user_profile', username=session['username']) }}'">Check Rank</button>
                <button class="btn-categories" id="categories-btn" onclick="window.location.href='{{ url_for('category') }}'">Categories</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const voteTitle = document.querySelector('.vote-title');
            const voteSubtitle = document.getElementById('vote-subtitle');
            const candidatesContainer = document.querySelector('.candidates-container');
            const candidates = document.querySelectorAll('.candidate');
            const nextBtn = document.getElementById('next-btn');
            const finalActions = document.getElementById('final-actions');
            const progressSection = document.querySelector('.progress-section');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const progressLabel = document.getElementById('progress-label');
            
            const maxVotes = parseInt('{{ MAX_VOTES }}', 10);
            const categoryId = parseInt('{{ category["id"] }}', 10);
            
            let winnerId = null;
            let loserId = null;
            let isVoting = false; // Prevent multiple clicks

            candidates.forEach(candidate => {
                candidate.addEventListener('click', function() {
                    if (isVoting) return;

                    winnerId = this.dataset.id;
                    loserId = [...candidates].find(c => c.dataset.id !== winnerId).dataset.id;

                    candidates.forEach(c => {
                        c.classList.remove('selected', 'not-selected');
                        if (c.dataset.id === winnerId) {
                            c.classList.add('selected');
                        } else {
                            c.classList.add('not-selected');
                        }
                    });
                    
                    nextBtn.classList.add('visible');
                });
            });

            nextBtn.addEventListener('click', async function() {
                if (winnerId && loserId && !isVoting) {
                    isVoting = true;
                    try {
                        const res = await fetch('/vote', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                winner_id: winnerId,
                                loser_id: loserId,
                                category_id: categoryId
                            })
                        });
                        const data = await res.json();
                        if (data.status === 'success') {
                            const percentage = (data.votes_in_category / maxVotes) * 100;
                            progressBarFill.style.width = percentage + '%';
                            progressLabel.textContent = `${data.votes_in_category} / ${maxVotes} Votes`;

                            if (data.unlocked) {
                                voteTitle.textContent = 'All Done!';
                                voteSubtitle.textContent = 'You can either check your rank or keep voting on other categories.';
                                voteSubtitle.style.display = 'block';

                                candidatesContainer.style.display = 'none';
                                progressSection.style.display = 'none';
                                nextBtn.style.display = 'none';
                                finalActions.classList.add('visible');
                            } else {
                                // Animate out, then reload content
                                candidatesContainer.classList.add('fade-out');
                                setTimeout(() => {
                                    window.location.reload();
                                }, 400); // Match CSS transition duration
                            }
                        } else {
                            alert(data.message || 'An error occurred.');
                            isVoting = false;
                        }
                    } catch (error) {
                        console.error('Error casting vote:', error);
                        alert('Could not connect to the server.');
                        isVoting = false;
                    }
                }
            });
        });
    </script>
</body>
</html>
